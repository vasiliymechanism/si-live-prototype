<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Scholarship Tracker — Mobile Mockup (2025)</title>
  <style>
    :root{
      --bg: #0b0d12; --surface: #11141b; --surface-2:#151924; --text:#e9ecf5;
      --muted:#9aa3b2; --primary:#4c82ff; --good:#22c55e; --warn:#f59e0b; --danger:#ef4444;
      --divider:rgba(255,255,255,0.07); --shadow:0 8px 28px rgba(0,0,0,0.35);
      --radius-xl:16px; --radius-lg:12px;
    }
    body{margin:0; font-family:ui-sans-serif,system-ui; background:var(--bg); color:var(--text); overflow:hidden;}
    .app{
      height:calc(100dvh - 74px - env(safe-area-inset-top) - env(safe-area-inset-bottom)); 
      max-width:420px; 
      margin:0 auto; 
      padding:calc(8px + env(safe-area-inset-top)) 12px 8px; 
      display:flex; 
      flex-direction:column; 
      gap:10px;
      overflow:hidden;
    }

    .accordion{
      border-radius:var(--radius-xl); 
      background:var(--surface); 
      border:1px solid var(--divider); 
      box-shadow:var(--shadow); 
      overflow:hidden; 
      cursor:pointer;
      transition: all 0.35s ease;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
    }
    
    .accordion[data-open="false"] {
      flex: 0 0 auto; /* Don't grow, don't shrink, auto height */
    }
    
    .accordion[data-open="true"] {
      flex: 1 1 0; /* Grow to fill space, but respect max constraints */
      max-height: calc(100% - 120px); /* Reserve space for other collapsed sections */
    }
    
    .acc-toggle{
      display:flex; 
      justify-content:space-between; 
      align-items:center; 
      padding:12px; 
      user-select:none;
      flex-shrink: 0;
    }
    
    .acc-body{
      overflow: hidden; 
      transition: all .35s ease; 
      border-top: 1px solid var(--divider);
      display: flex;
      flex-direction: column;
      min-height: 0;
      flex: 1 1 0; /* Take remaining space but don't exceed parent */
    }
    
    .accordion[data-open="false"] .acc-body{
      max-height: 0;
      border-top: none;
      flex: 0 0 0;
    }
    
    .accordion[data-open="true"] .acc-body{
      flex: 1 1 0;
      overflow: hidden;
      height: 0; /* Force content to be constrained by flex */
    }
    
    .acc-toggle .right{font-weight:700; font-size:16px;}

    .metrics-inline{display:flex; gap:6px; overflow:hidden; max-width:70%;}
    .metric{display:flex; gap:6px; align-items:center; padding:6px 10px; border-radius:999px; background:var(--surface-2); border:1px solid var(--divider); font-size:11px;}
    .metric .k{font-weight:700;}
    .metric .l{color:var(--muted);}
    .metrics-vertical{display:flex; flex-direction:column; gap:8px; padding:10px;}

    .feed-item,.task{border-radius:var(--radius-lg); background:var(--surface-2); border:1px solid var(--divider); padding:10px; margin-bottom: 8px;}
    .feed-item:last-child,.task:last-child{margin-bottom: 0;}
    .fi-top{display:flex; justify-content:space-between; font-size:14px; font-weight:600;}
    .bar{height:8px; border-radius:999px; background:rgba(255,255,255,0.08); margin-top:4px;}
    .bar .fill{
      height:100%; 
      width:var(--w,0%);
      border-radius:999px;
      transition: all 0.3s ease;
    }
    .bar .fill.normal{background:linear-gradient(90deg,var(--primary),#7aa2ff);}
    .bar .fill.caution{background:linear-gradient(90deg,var(--warn),#fbbf24);}
    .bar .fill.failed{background:linear-gradient(90deg,#6b7280,#9ca3af);}
    .bar .fill.success{background:linear-gradient(90deg,var(--good),#4ade80);}
    
    .status-text{
      font-size:10px; 
      color:var(--muted); 
      margin-top:2px;
      transition: color 0.3s ease;
    }
    .status-text.caution{color:var(--warn);}
    .status-text.failed{color:#9ca3af;}
    .status-text.success{color:var(--good);}
    .pill-mini{font-size:10px; padding:2px 6px; border-radius:999px; border:1px solid var(--divider);}
    .older{opacity:0.65;}

    .btn{border:1px solid var(--divider); background:transparent; color:var(--text); border-radius:10px; padding:6px 10px; font-size:12px;}
    .btn.primary{background:var(--primary); border-color:transparent; color:#fff;}
    .actions{display:flex; gap:8px; margin-top:6px;}

    .nav{position:fixed; bottom:calc(10px + env(safe-area-inset-bottom)); left:50%; transform:translateX(-50%); width:min(420px,92%); display:flex; justify-content:space-around; background:var(--surface); border:1px solid var(--divider); border-radius:14px; box-shadow:var(--shadow); padding:8px;}
    .nav a{flex:1; text-align:center; text-decoration:none; color:var(--muted); font-size:11px; padding:6px 0; border-radius:10px;}
    .nav a.active{color:var(--text); background:var(--surface-2); border:1px solid var(--divider);}

    /* Content containers with proper scrolling */
    .feed-content, .queue-content {
      padding: 10px;
      overflow-y: auto;
      flex-grow: 1;
    }
    
    .feed-content .feed-item, .queue-content .task {
      margin-bottom: 8px;
    }
    
    .searching-indicator {
      border-radius: var(--radius-lg);
      background: var(--surface-2);
      border: 1px solid var(--divider);
      padding: 10px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-style: italic;
      color: var(--muted);
      transition: all 0.3s ease;
    }
    
    .searching-icon {
      width: 16px;
      height: 16px;
      border: 2px solid var(--primary);
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
    }
    
    .ellipsis {
      display: inline-block;
    }
    
    .ellipsis::after {
      content: '';
      animation: ellipsis 1.5s infinite;
    }
    
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    
    .feed-content .feed-item:last-child, .queue-content .task:last-child {
      margin-bottom: 0;
    }
  </style>
</head>
<body>
  <div class="app">

    <!-- Metrics Accordion -->
    <section class="accordion" id="metrics" data-open="false">
      <div class="acc-toggle">
        <span>Metrics</span>
        <div class="metrics-inline" id="metrics-inline">
          <!-- Will be populated by JavaScript -->
        </div>
        <span class="right">+</span>
      </div>
      <div class="acc-body">
        <div class="metrics-vertical" id="metrics-vertical">
          <!-- Will be populated by JavaScript -->
        </div>
      </div>
    </section>

    <!-- Live Feed Accordion (default open) -->
    <section class="accordion" id="feed" data-open="true">
      <div class="acc-toggle">
        <div>
          <span class="title">Live Feed</span><br>
          <span class="subtitle">Real-time progress</span>
        </div>
        <span class="right">−</span>
      </div>
      <div class="acc-body">
        <div class="feed-content" id="feed-content">
          <!-- Will be populated by JavaScript -->
        </div>
      </div>
    </section>

    <!-- Action Required Accordion -->
    <section class="accordion" id="queue" data-open="false">
      <div class="acc-toggle">
        <div>
          <span class="title">Action Required</span><br>
          <span class="subtitle">Tasks blocking apps</span>
        </div>
        <span class="right">+</span>
      </div>
      <div class="acc-body">
        <div class="queue-content" id="queue-content">
          <!-- Will be populated by JavaScript -->
        </div>
      </div>
    </section>

  </div>
  <nav class="nav"><a class="active" href="#">Home</a><a href="#">Queue</a><a href="#">Metrics</a><a href="#">Account</a></nav>
  <script>
    // Data loading and rendering functions
    const API_BASE = './data/'; // For local files, change to your API endpoint later
    
    // Load and render metrics
    async function loadMetrics() {
      try {
        const response = await fetch(`${API_BASE}metrics.json`);
        const metrics = await response.json();
        renderMetrics(metrics);
      } catch (error) {
        console.error('Error loading metrics:', error);
        // Fallback data
        renderMetrics([
          {key: "3h 45m", label: "saved"},
          {key: "$124,500", label: "applied"},
          {key: "37", label: "matches"},
          {key: "12", label: "submitted"},
          {key: "4", label: "blocked"}
        ]);
      }
    }
    
    function renderMetrics(metrics) {
      const inlineContainer = document.getElementById('metrics-inline');
      const verticalContainer = document.getElementById('metrics-vertical');
      
      // Show first 3 metrics inline
      inlineContainer.innerHTML = metrics.slice(0, 3).map(m => 
        `<div class="metric"><span class="k">${m.key}</span><span class="l">${m.label}</span></div>`
      ).join('');
      
      // Show all metrics in expanded view
      verticalContainer.innerHTML = metrics.map(m => 
        `<div class="metric"><span class="k">${m.key}</span><span class="l">${m.label}</span></div>`
      ).join('');
    }
    
    // Load and render feed items
    async function loadFeed() {
      try {
        const response = await fetch(`${API_BASE}feed.json`);
        const feed = await response.json();
        feedData = [...feed]; // Store in global variable for live updates
        renderFeed(feedData);
      } catch (error) {
        console.error('Error loading feed:', error);
        // Fallback data
        feedData = [
          {name: "STEM Stars Scholarship", progress: 62, isOlder: false},
          {name: "Emerging Leaders Essay Award", progress: 28, isOlder: false},
          {name: "Community Builder Grant", progress: 100, isOlder: false},
          {name: "Local Community Service Award", progress: 100, isOlder: true},
          {name: "Innovation Challenge Grant", progress: 45, isOlder: false},
          {name: "Academic Excellence Award", progress: 78, isOlder: false}
        ];
        renderFeed(feedData);
      }
    }
    
    function renderFeed(feedItems) {
      // This function is now handled by updateFeedDisplay
      // Keeping for backwards compatibility with initial load
      const container = document.getElementById('feed-content');
      container.innerHTML = feedItems.map(item => 
        `<article class="feed-item ${item.isOlder ? 'older' : ''}">
          <div class="fi-top">
            <div>${item.name}</div>
            <div class="pill-mini">${item.progress}%</div>
          </div>
          <div class="bar">
            <div class="fill normal" style="--w:${item.progress}%"></div>
          </div>
          <div class="status-text normal">Loading...</div>
        </article>`
      ).join('');
    }
    
    // Load and render tasks
    async function loadTasks() {
      try {
        const response = await fetch(`${API_BASE}tasks.json`);
        const tasks = await response.json();
        renderTasks(tasks);
      } catch (error) {
        console.error('Error loading tasks:', error);
        // Fallback data
        renderTasks([
          {name: "Upload transcript (PDF)", time: "5 min", primaryAction: "Start", secondaryAction: "Later"},
          {name: "Polish leadership essay", time: "20 min", primaryAction: "Resume", secondaryAction: "Skip"},
          {name: "Request recommendation letter", time: "2 min", primaryAction: "Start", secondaryAction: "Later"},
          {name: "Complete financial aid form", time: "15 min", primaryAction: "Start", secondaryAction: "Later"}
        ]);
      }
    }
    
    function renderTasks(tasks) {
      const container = document.getElementById('queue-content');
      container.innerHTML = tasks.map(task => 
        `<article class="task">
          <div class="fi-top">
            <div>${task.name}</div>
            <div class="pill-mini">${task.time}</div>
          </div>
          <div class="actions">
            <button class="btn primary">${task.primaryAction}</button>
            <button class="btn">${task.secondaryAction}</button>
          </div>
        </article>`
      ).join('');
    }
    
    // Initialize app
    async function initApp() {
      await Promise.all([
        loadMetrics(),
        loadFeed(),
        loadTasks()
      ]);
      
      // Start live simulation after initial load
      await initLiveSimulation();
    }
    
    // Accordion functionality
    document.querySelectorAll('.accordion').forEach(acc => {
      const toggle=acc.querySelector('.acc-toggle'); const icon=acc.querySelector('.right'); const body=acc.querySelector('.acc-body');
      acc.addEventListener('click', e=>{
        const open=acc.getAttribute('data-open')==='true';
        document.querySelectorAll('.accordion').forEach(a=>{a.setAttribute('data-open','false'); a.querySelector('.right').textContent='+'; a.querySelector('.acc-body').setAttribute('aria-hidden','true');});
        if(!open){acc.setAttribute('data-open','true'); if(icon) icon.textContent='−'; if(body) body.setAttribute('aria-hidden','false');} else {acc.setAttribute('data-open','false'); if(icon) icon.textContent='+'; if(body) body.setAttribute('aria-hidden','true');}
      });
    });
    
    // Load data when page loads
    document.addEventListener('DOMContentLoaded', initApp);
    
    // Live feed simulation with search states
    let feedData = [];
    let simulationIndex = 0;
    let isSearching = false;
    let activeScholarships = new Map(); // Track state for each scholarship
    let stateConfig = null;
    
    // Scholarship states with their properties
    const STATES = {
      SCANNING: { progress: 5, label: "Scanning scholarship database", type: "normal" },
      CHECKING_DEADLINE: { progress: 15, label: "Checking application deadline", type: "normal" },
      DEADLINE_PASSED: { progress: 15, label: "Deadline has passed", type: "failed" },
      CHECKING_ELIGIBILITY: { progress: 30, label: "Verifying eligibility requirements", type: "normal" },
      NOT_ELIGIBLE: { progress: 30, label: "Not eligible for this scholarship", type: "failed" },
      MATCH_FOUND: { progress: 45, label: "Match found! Proceeding with application", type: "normal" },
      GETTING_REQUIREMENTS: { progress: 55, label: "Gathering application requirements", type: "normal" },
      PREPARING_MATERIALS: { progress: 65, label: "Preparing application materials", type: "normal" },
      ACTION_REQUIRED_MATERIALS: { progress: 65, label: "Action required: Upload documents", type: "caution" },
      GENERATING_ESSAY: { progress: 80, label: "AI generating personalized essay", type: "normal" },
      ACTION_REQUIRED_ESSAY: { progress: 80, label: "Action required: Review essay", type: "caution" },
      FINALIZING_APPLICATION: { progress: 95, label: "Finalizing application package", type: "normal" },
      READY_TO_SUBMIT: { progress: 100, label: "Application ready for submission", type: "success" },
      SUBMITTED: { progress: 100, label: "Application submitted successfully", type: "success" }
    };
    
    // Pool of realistic scholarship updates for simulation
    const simulationUpdates = [
      {name: "Future Leaders Engineering Grant", currentState: "SCANNING"},
      {name: "Women in Tech Scholarship", currentState: "SCANNING"},
      {name: "Community Impact Award", currentState: "SCANNING"},
      {name: "First Generation College Grant", currentState: "SCANNING"},
      {name: "Environmental Science Fellowship", currentState: "SCANNING"},
      {name: "Merit-Based Achievement Award", currentState: "SCANNING"},
      {name: "Research Excellence Grant", currentState: "SCANNING"},
      {name: "Local Business Scholarship", currentState: "SCANNING"},
      {name: "Arts & Culture Foundation Grant", currentState: "SCANNING"},
      {name: "Healthcare Heroes Scholarship", currentState: "SCANNING"},
      {name: "Innovation Challenge Award", currentState: "SCANNING"},
      {name: "Student Leadership Grant", currentState: "SCANNING"}
    ];
    
    // Load state configuration
    async function loadStateConfig() {
      try {
        const response = await fetch(`${API_BASE}state-config.json`);
        stateConfig = await response.json();
      } catch (error) {
        console.error('Error loading state config:', error);
        // Fallback configuration
        stateConfig = {
          SCANNING: { CHECKING_DEADLINE: 1.0 },
          CHECKING_DEADLINE: { CHECKING_ELIGIBILITY: 0.8, DEADLINE_PASSED: 0.2 },
          CHECKING_ELIGIBILITY: { MATCH_FOUND: 0.7, NOT_ELIGIBLE: 0.3 },
          MATCH_FOUND: { GETTING_REQUIREMENTS: 1.0 },
          GETTING_REQUIREMENTS: { PREPARING_MATERIALS: 1.0 },
          PREPARING_MATERIALS: { ACTION_REQUIRED_MATERIALS: 0.3, GENERATING_ESSAY: 0.7 },
          ACTION_REQUIRED_MATERIALS: { GENERATING_ESSAY: 1.0 },
          GENERATING_ESSAY: { ACTION_REQUIRED_ESSAY: 0.4, FINALIZING_APPLICATION: 0.6 },
          ACTION_REQUIRED_ESSAY: { FINALIZING_APPLICATION: 1.0 },
          FINALIZING_APPLICATION: { READY_TO_SUBMIT: 0.8, SUBMITTED: 0.2 },
          READY_TO_SUBMIT: { SUBMITTED: 1.0 }
        };
      }
    }
    
    function getNextState(currentState) {
      const transitions = stateConfig[currentState];
      if (!transitions) return null;
      
      const rand = Math.random();
      let cumulative = 0;
      
      for (const [nextState, probability] of Object.entries(transitions)) {
        cumulative += probability;
        if (rand <= cumulative) {
          return nextState;
        }
      }
      
      // Fallback to first state if probabilities don't add up to 1
      return Object.keys(transitions)[0];
    }
    
    function isTerminalState(state) {
      return ['DEADLINE_PASSED', 'NOT_ELIGIBLE', 'ACTION_REQUIRED_MATERIALS', 'ACTION_REQUIRED_ESSAY', 'SUBMITTED'].includes(state);
    }
    
    function progressScholarship(scholarshipId) {
      const scholarship = activeScholarships.get(scholarshipId);
      if (!scholarship) return;
      
      const nextState = getNextState(scholarship.currentState);
      if (nextState) {
        scholarship.currentState = nextState;
        scholarship.lastUpdated = Date.now();
        
        // Update the feed display
        updateFeedDisplay();
        
        // Continue progression if not in terminal state
        if (!isTerminalState(nextState)) {
          setTimeout(() => {
            progressScholarship(scholarshipId);
          }, Math.random() * 1000 + 500); // 0.5-1.5 second delays
        } else {
          // Terminal state reached, start searching for next scholarship
          setTimeout(() => {
            if (simulationIndex < simulationUpdates.length) {
              showSearchingIndicator();
            }
          }, Math.random() * 1000 + 1000); // 1-2 second delay before next search
        }
      }
    }
    
    function updateFeedDisplay() {
      const feedContainer = document.getElementById('feed-content');
      let html = '';
      
      // Add searching indicator if active
      if (isSearching) {
        html += `<div class="searching-indicator">
          <div class="searching-icon"></div>
          <span>Searching for new scholarships<span class="ellipsis"></span></span>
        </div>`;
      }
      
      // Add active scholarships
      const sortedScholarships = Array.from(activeScholarships.values())
        .sort((a, b) => b.lastUpdated - a.lastUpdated);
      
      sortedScholarships.forEach(scholarship => {
        const state = STATES[scholarship.currentState];
        const isOlder = sortedScholarships.indexOf(scholarship) >= 6;
        
        html += `<article class="feed-item ${isOlder ? 'older' : ''}">
          <div class="fi-top">
            <div>${scholarship.name}</div>
            <div class="pill-mini">${state.progress}%</div>
          </div>
          <div class="bar">
            <div class="fill ${state.type}" style="--w:${state.progress}%"></div>
          </div>
          <div class="status-text ${state.type}">${state.label}</div>
        </article>`;
      });
      
      feedContainer.innerHTML = html;
      feedContainer.scrollTop = 0;
    }
    
    function showSearchingIndicator() {
      isSearching = true;
      updateFeedDisplay();
      
      // Find new scholarship after 2-4 seconds
      setTimeout(() => {
        addLiveFeedUpdate();
      }, Math.random() * 2000 + 2000);
    }
    
    function addLiveFeedUpdate() {
      if (simulationIndex < simulationUpdates.length) {
        // Hide searching indicator
        isSearching = false;
        
        // Create new scholarship
        const newScholarship = {
          ...simulationUpdates[simulationIndex],
          id: `scholarship_${simulationIndex}`,
          lastUpdated: Date.now()
        };
        
        activeScholarships.set(newScholarship.id, newScholarship);
        simulationIndex++;
        
        // Update display and start progression
        updateFeedDisplay();
        
        // Start progressing this scholarship through states
        setTimeout(() => {
          progressScholarship(newScholarship.id);
        }, 500);
        
      } else {
        // Reset simulation after all items are shown
        setTimeout(() => {
          simulationIndex = 0;
          activeScholarships.clear();
          isSearching = false;
          updateFeedDisplay();
        }, 10000);
      }
    }
    
    // Initialize state configuration and start simulation
    async function initLiveSimulation() {
      await loadStateConfig();
      
      // Start live updates 3 seconds after page load
      setTimeout(() => {
        showSearchingIndicator();
      }, 3000);
    }
    
    // Optional: Auto-refresh static data every 30 seconds
    // setInterval(initApp, 30000);
  </script>
</body>
</html>